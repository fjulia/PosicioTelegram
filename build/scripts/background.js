function iconClicked(){chrome.browserAction.setIcon({path:"icons/sendme_disabled.png"}),setTimeout(function(){chrome.browserAction.setIcon({path:"icons/truck.png"})},100),chrome.tabs.getSelected(null,function(e){var t=e.url;if(-1!=t.indexOf("https://www.google.es/maps")){var o;-1!=t.indexOf("https://www.google.es/maps/dir")?o=t.split("/")[6]:(o=t.split("/")[5],localStorage.telegram_origin&&""!=localStorage.telegram_origin&&doAddOriginToURL(e,localStorage.telegram_origin)),doGetCoords(o,function(e,t){doSendPosition(e,t)})}})}function doGetCoords(e,t){var o=new XMLHttpRequest,n=googleMapsApi_URL+"geocode/json?address="+e;o.open("GET",n,!0),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Access-Control-Allow-Origin","*"),o.setRequestHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var e=JSON.parse(o.responseText);t&&t(e.results[0].formatted_address,e.results[0].geometry.location)}},o.send()}function doSendPosition(e,t,o){var n=localStorage.telegram_bot_token,s=localStorage.telegram_group_id,r=t.lat,a=t.lng;sendMessage(n,s,e,function(){sendLocation(n,s,r,a,o)})}function doAddOriginToURL(e,t,o){var n=e.url,s=n.split("/");s[4]="dir",s.splice(5,0,encodeURIComponent(t));var r=s.join("/");chrome.tabs.update(e.id,{url:r})}function sendLocation(e,t,o,n,s){var r=new XMLHttpRequest,a=telegramApi_URL+"bot"+e+"/sendLocation";r.open("POST",a,!0),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){JSON.parse(r.responseText);s&&s()}};var i=JSON.stringify({chat_id:t,latitude:o,longitude:n});r.send(i)}function sendMessage(e,t,o,n){var s=new XMLHttpRequest,r=telegramApi_URL+"bot"+e+"/sendMessage";s.open("POST",r,!0),s.setRequestHeader("Content-type","application/json"),s.onreadystatechange=function(){if(4==s.readyState&&200==s.status){JSON.parse(s.responseText);n&&n()}};var a=JSON.stringify({chat_id:t,text:o});s.send(a)}function setPopup(){chrome.browserAction.setPopup({popup:""}),chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setIcon({path:"icons/truck.png"}),chrome.browserAction.setTitle({title:"PosicioTelegram"}),chrome.browserAction.onClicked.addListener(iconClicked)}function setPopupWellcome(){chrome.browserAction.setPopup({popup:"popup.html"}),chrome.browserAction.setIcon({path:"icons/truck_disabled.png"}),chrome.browserAction.setBadgeText({text:"ID !"})}function alreadyConfigured(){setPopup()}chrome.extension.onMessage.addListener(function(e,t,o){function n(){xhr=new XMLHttpRequest;var t=telegramApi_URL+"bot"+e.bot_id+"/getUpdates";xhr.open("GET",t,!0),xhr.setRequestHeader("Content-type","application/json"),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var t=JSON.parse(xhr.responseText);t.result.forEach(function(t){t.message.chat.title==e.groupName&&(localStorage.telegram_group_id=t.message.chat.id)}),localStorage.telegram_group_id?(alreadyConfigured(),chrome.extension.sendMessage({status:"configured_ok"})):setTimeout(function(){n()},1e4)}},xhr.send()}"createGroup"==e.msg?(localStorage.telegram_bot_token=e.bot_id,localStorage.telegram_group_name=e.groupName,localStorage.telegram_origin=e.origin,n()):"configured"==e.msg?(alreadyConfigured(),o({status:"ok"})):"reset"==e.msg&&(setPopupWellcome(),o({status:"ok"}))});var test_bot_id="186718542:AAE38mXwxSRPw95m89Vbx1b4NMvOkuU4GuQ",telegramApi_URL="https://api.telegram.org/",googleMapsApi_URL="https://maps.googleapis.com/maps/api/";void(window.console||(window.console={log:function(){},dir:function(){}})),localStorage.telegram_bot_token&&localStorage.telegram_group_id?setPopup():setPopupWellcome();