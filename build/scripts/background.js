function iconClicked(){chrome.browserAction.setIcon({path:"truck_disabled.png"}),setTimeout(function(){chrome.browserAction.setIcon({path:"truck.png"})},100),chrome.tabs.getSelected(null,function(e){var t=e.url;if(-1!=t.indexOf("https://www.google.es/maps")){var o;o=-1!=t.indexOf("https://www.google.es/maps/dir")?t.split("/")[6]:t.split("/")[5];var n;localStorage.telegram_origin&&""!==localStorage.telegram_origin&&(n=getOriginToURL(t,localStorage.telegram_origin),chrome.tabs.update(e.id,{url:n})),doGetCoords(o,function(e,t){doSendPosition(e,t,n,function(){chrome.browserAction.setIcon({path:"truck.png"})})})}})}function doGetCoords(e,t){var o=new XMLHttpRequest,n=googleMapsApi_URL+"geocode/json?address="+e;o.open("GET",n,!0),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Access-Control-Allow-Origin","*"),o.setRequestHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var e=JSON.parse(o.responseText);t&&t(e.results[0].formatted_address,e.results[0].geometry.location)}},o.send()}function doSetRouteOriginButton(e,t,o){var n=localStorage.telegram_bot_token,r=localStorage.telegram_group_id,a={inline_keyboard:[]};a.inline_keyboard[0]=[];var s={text:"Ruta des de Origen",url:t};a.inline_keyboard[0].push(s),setReplyKeyBoardButton(n,r,e,a,o)}function doSendPosition(e,t,o,n){var r=localStorage.telegram_bot_token,a=localStorage.telegram_group_id,s=t.lat,i=t.lng;sendMessage(r,a,e,function(){sendLocation(r,a,s,i,function(e){o&&"true"==localStorage.telegram_send_ruta&&doSetRouteOriginButton(e,o,n)})})}function getOriginToURL(e,t){var o=e.split("/");"place"==o[4]&&(o[4]="dir",o.splice(5,0,encodeURIComponent(t)));var n=o.join("/");return n}function setReplyKeyBoardButton(e,t,o,n,r){var a=new XMLHttpRequest,s=telegramApi_URL+"bot"+e+"/editMessageReplyMarkup";a.open("POST",s,!0),a.setRequestHeader("Content-type","application/json"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){JSON.parse(a.responseText);r&&r()}};var i=JSON.stringify({chat_id:t,message_id:o,reply_markup:n});a.send(i)}function sendLocation(e,t,o,n,r){var a=new XMLHttpRequest,s=telegramApi_URL+"bot"+e+"/sendLocation";a.open("POST",s,!0),a.setRequestHeader("Content-type","application/json"),a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var e=JSON.parse(a.responseText);r&&r(e.result.message_id)}};var i=JSON.stringify({chat_id:t,latitude:o,longitude:n});a.send(i)}function sendMessage(e,t,o,n){var r=new XMLHttpRequest,a=telegramApi_URL+"bot"+e+"/sendMessage";r.open("POST",a,!0),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var e=JSON.parse(r.responseText);n&&n(e.result.message_id)}};var s=JSON.stringify({chat_id:t,text:o});r.send(s)}function setPopup(){chrome.browserAction.setPopup({popup:""}),chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setIcon({path:"truck.png"}),chrome.browserAction.setTitle({title:"PosicioTelegram"}),chrome.browserAction.onClicked.addListener(iconClicked)}function setPopupWellcome(){chrome.browserAction.setPopup({popup:"popup.html"}),chrome.browserAction.setIcon({path:"truck_disabled.png"}),chrome.browserAction.setBadgeText({text:"ID !"})}function alreadyConfigured(){setPopup()}chrome.extension.onMessage.addListener(function(e,t,o){function n(t){if(t||(t=0),10>t){xhr=new XMLHttpRequest;var o=telegramApi_URL+"bot"+e.bot_id+"/getUpdates";xhr.open("GET",o,!0),xhr.setRequestHeader("Content-type","application/json"),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var o=JSON.parse(xhr.responseText);o.result.forEach(function(t){t.message.chat.title==e.groupName&&(localStorage.telegram_group_id=t.message.chat.id)}),localStorage.telegram_group_id?(alreadyConfigured(),chrome.extension.sendMessage({status:"configured_ok"})):setTimeout(function(){n(t+1)},1e4)}},xhr.send()}else chrome.extension.sendMessage({status:"configured_failed"})}"createGroup"==e.msg?(localStorage.telegram_bot_token=e.bot_id,localStorage.telegram_group_name=e.groupName,e.origin&&""!==e.origin&&(localStorage.telegram_origin=e.origin),n()):"configured"==e.msg?(alreadyConfigured(),o({status:"ok"})):"reset"==e.msg&&(setPopupWellcome(),o({status:"ok"}))});var telegramApi_URL="https://api.telegram.org/",googleMapsApi_URL="https://maps.googleapis.com/maps/api/";window.console||(window.console={log:function(){},dir:function(){}}),localStorage.telegram_bot_token&&localStorage.telegram_group_id?setPopup():setPopupWellcome();