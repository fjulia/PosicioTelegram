function iconClicked(){chrome.browserAction.setIcon({path:"truck_disabled.png"}),setTimeout(function(){chrome.browserAction.setIcon({path:"truck.png"})},100),chrome.tabs.getSelected(null,function(e){var t=e.url;if(-1!=t.indexOf("https://www.google.es/maps")){var o;-1!=t.indexOf("https://www.google.es/maps/dir")?o=t.split("/")[6]:(o=t.split("/")[5],localStorage.telegram_origin&&""!=localStorage.telegram_origin&&doAddOriginToURL(e,localStorage.telegram_origin)),doGetCoords(o,function(e,t){doSendPosition(e,t,function(){chrome.browserAction.setIcon({path:"truck.png"})})})}})}function doGetCoords(e,t){var o=new XMLHttpRequest,n=googleMapsApi_URL+"geocode/json?address="+e;o.open("GET",n,!0),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Access-Control-Allow-Origin","*"),o.setRequestHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var e=JSON.parse(o.responseText);t&&t(e.results[0].formatted_address,e.results[0].geometry.location)}},o.send()}function doSendPosition(e,t,o){var n=localStorage.telegram_bot_token,r=localStorage.telegram_group_id,s=t.lat,a=t.lng;sendMessage(n,r,e,function(){sendLocation(n,r,s,a,o)})}function doAddOriginToURL(e,t,o){var n=e.url,r=n.split("/");r[4]="dir",r.splice(5,0,encodeURIComponent(t));var s=r.join("/");chrome.tabs.update(e.id,{url:s})}function sendLocation(e,t,o,n,r){var s=new XMLHttpRequest,a=telegramApi_URL+"bot"+e+"/sendLocation";s.open("POST",a,!0),s.setRequestHeader("Content-type","application/json"),s.onreadystatechange=function(){if(4==s.readyState&&200==s.status){JSON.parse(s.responseText);r&&r()}};var i=JSON.stringify({chat_id:t,latitude:o,longitude:n});s.send(i)}function sendMessage(e,t,o,n){var r=new XMLHttpRequest,s=telegramApi_URL+"bot"+e+"/sendMessage";r.open("POST",s,!0),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){JSON.parse(r.responseText);n&&n()}};var a=JSON.stringify({chat_id:t,text:o});r.send(a)}function setPopup(){chrome.browserAction.setPopup({popup:""}),chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setIcon({path:"truck.png"}),chrome.browserAction.setTitle({title:"PosicioTelegram"}),chrome.browserAction.onClicked.addListener(iconClicked)}function setPopupWellcome(){chrome.browserAction.setPopup({popup:"popup.html"}),chrome.browserAction.setIcon({path:"truck_disabled.png"}),chrome.browserAction.setBadgeText({text:"ID !"})}function alreadyConfigured(){setPopup()}chrome.extension.onMessage.addListener(function(e,t,o){function n(t){if(t||(t=0),10>t){xhr=new XMLHttpRequest;var o=telegramApi_URL+"bot"+e.bot_id+"/getUpdates";xhr.open("GET",o,!0),xhr.setRequestHeader("Content-type","application/json"),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var o=JSON.parse(xhr.responseText);o.result.forEach(function(t){t.message.chat.title==e.groupName&&(localStorage.telegram_group_id=t.message.chat.id)}),localStorage.telegram_group_id?(alreadyConfigured(),chrome.extension.sendMessage({status:"configured_ok"})):setTimeout(function(){n(t+1)},1e4)}},xhr.send()}else chrome.extension.sendMessage({status:"configured_failed"})}"createGroup"==e.msg?(localStorage.telegram_bot_token=e.bot_id,localStorage.telegram_group_name=e.groupName,e.origin&&""!=e.origin&&(localStorage.telegram_origin=e.origin),n()):"configured"==e.msg?(alreadyConfigured(),o({status:"ok"})):"reset"==e.msg&&(setPopupWellcome(),o({status:"ok"}))});var telegramApi_URL="https://api.telegram.org/",googleMapsApi_URL="https://maps.googleapis.com/maps/api/";void(window.console||(window.console={log:function(){},dir:function(){}})),localStorage.telegram_bot_token&&localStorage.telegram_group_id?setPopup():setPopupWellcome();